"use strict";(()=>{var a={};a.id=39,a.ids=[39,458],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{a.exports=require("punycode")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{a.exports=require("path")},37830:a=>{a.exports=require("node:stream/web")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54875:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>E,patchFetch:()=>D,routeModule:()=>z,serverHooks:()=>C,workAsyncStorage:()=>A,workUnitAsyncStorage:()=>B});var d={};c.r(d),c.d(d,{POST:()=>y});var e=c(32460),f=c(30481),g=c(45576),h=c(38042),i=c(73368),j=c(261),k=c(26390),l=c(34332),m=c(38676),n=c(14183),o=c(59921),p=c(50019),q=c(96589),r=c(56938),s=c(86439),t=c(19912),u=c(17925),v=c(668),w=c(57077),x=c(72042);async function y(a){let b=await a.json(),c=b.query??b.prompt,d=!!b.alwaysFindMolecule;if(!c)return u.NextResponse.json({error:"Missing prompt",status:"failed"},{status:400});try{let a=await (0,w.dY)(c,d);console.log(`[PubChemService] Classification: ${JSON.stringify(a)}`);let b=a.name??"",e="small molecule";if("unknown"===a.type)return u.NextResponse.json({status:"failed",error:'Non-molecular prompt: Your prompt should be related to molecular structures. Click on the "Suggest Molecule" button to get started.'},{status:200});e="macromolecule"===a.type?"macromolecule":"small molecule",b=a.name??"";let f=await (0,v.l4)(b,e);try{let a=f.sdf||"";if(a&&a.trim().length>0){let c=await (0,x.S)(a),d=c?.groups?.length??0;console.log(`[FunctionalGroups][server] ${f.name||b}: ${d} groups detected`)}else console.log(`[FunctionalGroups][server] ${f.name||b}: 0 groups (no SDF)`)}catch(a){console.warn("[FunctionalGroups][server] detection failed:",a)}return u.NextResponse.json({pdb_data:f.pdb_data,sdf:f.sdf,name:f.name,cid:f.cid,formula:f.formula,info:f.info,moleculeType:e,pdb_id:f.pdb_id,smiles:f.info?.canonical_smiles||f.info?.isomeric_smiles})}catch(b){let a=b instanceof Error?b.message:"Unknown error occurred";return u.NextResponse.json({status:"failed",error:a},{status:500})}}let z=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/prompt/fetch-molecule-data/route",pathname:"/api/prompt/fetch-molecule-data",filename:"route",bundlePath:"app/api/prompt/fetch-molecule-data/route"},distDir:".next",projectDir:"",resolvedPagePath:"/Users/jakekinchen/Documents/moleculens/apps/web/app/api/prompt/fetch-molecule-data/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:A,workUnitAsyncStorage:B,serverHooks:C}=z;function D(){return(0,g.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:B})}async function E(a,b,c){var d;let e="/api/prompt/fetch-molecule-data/route";"/index"===e&&(e="/");let g=await z.prepare(a,b,{srcPage:e,multiZoneDraftMode:"false"});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||z.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===z.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{dynamicIO:!!w.experimental.dynamicIO,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>z.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>z.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await z.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await z.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await z.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},55591:a=>{a.exports=require("https")},57075:a=>{a.exports=require("node:stream")},57077:(a,b,c)=>{c.d(b,{dY:()=>k,ei:()=>i,generatePresentationScript:()=>l});var d=c(32482),e=c(28077),f=c(668);let g=process.env.OPENAI_API_KEY,h=g?new d.Ay({apiKey:g}):void 0;async function i(a){if(!h)throw Error("LLM not configured");let b=await h.chat.completions.create({model:"o3-mini",messages:[{role:"user",content:a}]});return b.choices[0]?.message?.content??""}async function j(a,b){let c;if(!h)throw Error("LLM not configured");let d=await h.chat.completions.create({model:"o3-mini",messages:[{role:"user",content:a}]}),e=d.choices[0]?.message?.content??"";try{c=JSON.parse(e)}catch(a){throw Error("Structured LLM response is not valid JSON")}return b.parse(c)}async function k(a,b=!1){if(!h)return console.warn("LLM not configured. Defaulting to small molecule classification."),{type:"small molecule",name:(0,f.rh)(a)};let c=b?`
CRITICAL OVERRIDE: Always come up with a molecule based on the user's prompt, no matter the prompt. Try to find the closest related molecule to whatever is mentioned. If there is literally nothing even remotely possible, then invent a plausible molecule name as a stand-in. You may only classify the molecule as "small molecule" or "macromolecule". Get creative, if there's something imagined or mispelled, make something up or find the closest semantically related molecule.`:"",d=`You are a chemical assistant. Classify the following user input as a 'small molecule', 'macromolecule', or 'unknown'. If a specific molecule or macromolecule can be identified, provide its common name. Respond ONLY with JSON in the form {"type":"molecule|macromolecule|unknown","name":"<name>"}. For example if the prompt is "Tell me about the structure of glucose", the response should be {"type":"small molecule","name":"glucose"} or if the prompt is "Tell me about the structure of a protein", the response should be {"type":"macromolecule","name":"leucine", or if the prompt is "Teach me about metal-carbonyl complexes and back-bonding", the response should be {"type":"small molecule","name":"nickel tetracarbonyl" or with "Teach me about metal-metal quadruple bonds in dimolybdenum complexes", the response should be {"type":"small molecule","name":"dimolybdenum tetraacetate"}.${c}

User input: "${a}"`,g=await j(d,e.Ik({type:e.k5(["small molecule","macromolecule","unknown"]),name:e.Yj().nullable()}));return{type:g.type,name:g.name?(0,f.rh)(g.name):null}}async function l(a){if(!h)throw Error("LLM not configured for presentation generation");let{name:b,formula:c,info:d}=a,f=`Molecule: ${b}`;c&&(f+=`
Formula: ${c}`),d&&"object"==typeof d&&"canonical_smiles"in d&&(f+=`
SMILES: ${d.canonical_smiles}`),d&&"object"==typeof d&&"synonyms"in d&&Array.isArray(d.synonyms)&&(f+=`
Synonyms: ${d.synonyms.slice(0,3).join(", ")}`),d&&"object"==typeof d&&"formula_weight"in d&&(f+=`
Molecular Weight: ${d.formula_weight} g/mol`),d&&"object"==typeof d&&"experimental_method"in d&&(f+=`
Experimental Method: ${d.experimental_method}`),d&&"object"==typeof d&&"resolution"in d&&(f+=`
Resolution: ${d.resolution} \xc5`);let g=`You are creating an educational presentation script for a 3D molecular visualization. Generate a presentation script that highlights different parts of the molecule over time with educational captions.

${f}

Create a presentation script with 4-6 steps that:
1. Introduces the molecule and its significance
2. Highlights different structural features or functional groups
3. Explains key properties or biological/chemical importance
4. Concludes with applications or interesting facts

Each step should:
- Have a timecode in "MM:SS" format (starting at 00:00, incrementing by 5-10 seconds)
- Specify which atoms to highlight (use atom indices as strings, e.g., ["0", "1", "2"])
- Include an educational caption (1-2 sentences, under 120 characters)

For atom indices:
- Use empty array [] for general introduction
- Use specific atom indices to highlight structural features
- For small molecules, typically have 5-20 atoms (indices 0-19)
- For larger molecules, focus on key functional groups or active sites

EXAMPLE for glucose (C6H12O6):
{
  "title": "Glucose: Essential Sugar Molecule",
  "content": [
    {
      "timecode": "00:00",
      "atoms": [],
      "caption": "Glucose is a simple sugar and primary energy source for living cells."
    },
    {
      "timecode": "00:05",
      "atoms": ["0", "1", "2", "3", "4", "5"],
      "caption": "The six-carbon backbone forms a ring structure in aqueous solution."
    },
    {
      "timecode": "00:10",
      "atoms": ["6", "7", "8", "9", "10"],
      "caption": "Five hydroxyl groups make glucose highly water-soluble."
    },
    {
      "timecode": "00:15",
      "atoms": ["11"],
      "caption": "The aldehyde group can form hemiacetal bonds, creating ring structures."
    },
    {
      "timecode": "00:20",
      "atoms": ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11"],
      "caption": "Glucose is metabolized through glycolysis to produce cellular energy (ATP)."
    }
  ]
}

Now generate a similar script for ${b}. Respond ONLY with JSON in the exact format shown above:`;return await j(g,e.Ik({title:e.Yj(),content:e.YO(e.Ik({timecode:e.Yj(),atoms:e.YO(e.Yj()),caption:e.Yj()}))}))}},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},72042:(a,b,c)=>{c.d(b,{S:()=>g});let d=null,e=[{id:"hydroxyl",name:"Hydroxyl",smarts:"[OX2H]",smiles:"[OH]",description:"Alcohol/phenol OH"},{id:"carbonyl",name:"Carbonyl",smarts:"[CX3]=[OX1]",smiles:"C=O",description:"C=O (ketone/aldehyde)"},{id:"carboxylate",name:"Carboxylate",smarts:"C(=O)[O-]",description:"Deprotonated carboxyl"},{id:"carboxylic_acid",name:"Carboxylic acid",smarts:"C(=O)O[H]",smiles:"OC=O",description:"COOH"},{id:"ester",name:"Ester",smarts:"C(=O)O[C;!H0]",smiles:"COOC",description:"Ester linkage"},{id:"amide",name:"Amide",smarts:"C(=O)N",smiles:"NC=O",description:"Amide linkage"},{id:"primary_amine",name:"Primary amine",smarts:"[NX3;H2;!$(NC=O)]",smiles:"N",description:"R-NH2"},{id:"secondary_amine",name:"Secondary amine",smarts:"[NX3;H1;!$(NC=O)]",smiles:"NC",description:"R2NH"},{id:"tertiary_amine",name:"Tertiary amine",smarts:"[NX3;H0;!$(NC=O)]",smiles:"N(C)C",description:"R3N"},{id:"nitro",name:"Nitro",smarts:"[$([NX3](=O)=O)]",smiles:"[N+](=O)[O-]",description:"NO2"},{id:"halogen",name:"Halogen",smarts:"[F,Cl,Br,I]",description:"Halogen atom"},{id:"aromatic_ring",name:"Aromatic ring",smarts:"a1aaaaa1",description:"Benzene-like ring"},{id:"aromatic_ring_kekule",name:"Aromatic ring (backup)",smarts:"C1=CC=CC=C1",smiles:"C1=CC=CC=C1",description:"Fallback for benzene-like rings encoded with alternating bonds"},{id:"aromatic_ring_aromatic_carbon",name:"Aromatic ring (aromatic carbons)",smarts:"c1ccccc1",smiles:"c1ccccc1",description:"Fallback for aromatic carbons ring"},{id:"imidazole_like",name:"Imidazole-like ring",smarts:"n1c[nH]c1",smiles:"n1c[nH]c1",description:"Generic five-membered heteroaromatic ring (approx.)"},{id:"purine_like",name:"Purine/Xanthine-like core",smarts:"n1c2ncnc2n1",smiles:"n1c2ncnc2n1",description:"Fused bicyclic heteroaromatic (approx.)"},{id:"imide_like",name:"Imide-like (dicarbonyl N)",smarts:"N(C=O)C=O",smiles:"N(C=O)C=O",description:"Two carbonyls on nitrogen (imide-like)"}],f=new Map;async function g(a){let b=`sdf:${function(a){let b=0;for(let c=0;c<a.length;c++)b=31*b+a.charCodeAt(c)|0;return`${b}`}(a)}`,g=f.get(b);if(g)return g;let h=await (!d&&(d=c.e(83).then(c.bind(c,84083)).then(a=>a.default??a)),d),i=h.Molecule.fromMolfile(a);if("function"==typeof h.Molecule.prototype.ensureHelperArrays){let a=(h.Molecule.cHelperRings||0)|(h.Molecule.cHelperAromaticity||0);i.ensureHelperArrays?.(a)}let j=[],k=new Map;for(let a of e){let b;if("function"==typeof h.Molecule.fromSmarts)b=h.Molecule.fromSmarts(a.smarts);else if(h.SmartsParser&&"function"==typeof h.SmartsParser.parse)b=h.SmartsParser.parse(a.smarts);else if(h.SmilesParser&&"function"==typeof h.SmilesParser.parse)try{b=h.SmilesParser.parse(a.smarts)}catch{b=null}if(!b)continue;let c=[];try{let a=new h.SSSearcherWithIndex;a.setFragment(b),a.setMolecule(i);let d=a.findMatches?.()??a.search?.();if(Array.isArray(d))for(let a of d)Array.isArray(a)&&c.push(a)}catch{try{let a=new h.SSSearcher;a.setMol?.(i),a.setMolecule?.(i),a.setFragment?.(b);let d=a.findMatches?.()??a.search?.();if(Array.isArray(d))for(let a of d)Array.isArray(a)&&c.push(a);else if(d&&"number"==typeof d.length&&"function"==typeof d.get)for(let a=0;a<d.length;a++){let b=d.get(a),e=[];for(let a=0;a<b.length;a++)e.push(b[a]);c.push(e)}}catch{}}if(c.length>0){let b=new Set;c.forEach(a=>a.forEach(a=>b.add(a)));let d={id:a.id,name:a.name,atoms:Array.from(b.values()),smarts:a.smarts,description:a.description};j.push(d),d.atoms.forEach(a=>{let b=k.get(a)||[];b.push(d.id),k.set(a,b)})}}let l={groups:j,atomToGroupIds:k};return f.set(b,l),l}},73024:a=>{a.exports=require("node:fs")},73566:a=>{a.exports=require("worker_threads")},74075:a=>{a.exports=require("zlib")},79551:a=>{a.exports=require("url")},81630:a=>{a.exports=require("http")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[431,446,482,77,891,181,668],()=>b(b.s=54875));module.exports=c})();